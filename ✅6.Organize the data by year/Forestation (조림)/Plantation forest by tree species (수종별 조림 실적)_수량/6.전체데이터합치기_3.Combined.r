# ğŸŸ¥ (23ë…„ë„ + 04~22ë…„ë„ + 00ë…„ë„) + êµ­ìœ ë¦¼ë¯¼ìœ ë¦¼ ===================================================================================================
## ğŸŸ© ë°ì´í„° ë¡œë“œ ===========================================================================================
path_data_1999 = "/Users/Ido/Documents/GitHub/KFS_Timeseries_Data/4.Exported Data_by ID/@_á„Œá…©á„…á…µá†·/(@á„‹á…ªá†«á„…á…­)á„‰á…®á„Œá…©á†¼á„‡á…§á†¯ á„Œá…©á„…á…µá†·á„‰á…µá†¯á„Œá…¥á†¨Plantation forest by tree species/@á„‹á…ªá†«á„…á…­/(@á„‹á…ªá†«á„…á…­)2.á„€á…®á†¨á„‹á…²á„…á…µá†·á„†á…µá†«á„‹á…²á„…á…µá†·.xlsx"
path_combined = "/Users/Ido/Documents/GitHub/KFS_Timeseries_Data/4.Exported Data_by ID/@_á„Œá…©á„…á…µá†·/(@á„‹á…ªá†«á„…á…­)á„‰á…®á„Œá…©á†¼á„‡á…§á†¯ á„Œá…©á„…á…µá†·á„‰á…µá†¯á„Œá…¥á†¨Plantation forest by tree species/@á„‹á…ªá†«á„…á…­/6.á„Œá…¥á†«á„á…¦á„ƒá…¦á„‹á…µá„á…¥á„’á…¡á†¸á„á…µá„€á…µ/2.Combined.xlsx"

data_1999 = read.xlsx(path_data_1999)
data_1999_sub = data_1999[1:17]
data_combined = read.xlsx(path_combined)
data_combined_sub = data_combined[1:20]


# test = read.xlsx("/Users/Ido/Documents/GitHub/KFS_Timeseries_Data/4.Exported Data_by ID/@_á„Œá…©á„…á…µá†·/(@á„‹á…ªá†«á„…á…­)á„‰á…®á„Œá…©á†¼á„‡á…§á†¯ á„Œá…©á„…á…µá†·á„‰á…µá†¯á„Œá…¥á†¨Plantation forest by tree species/@á„‹á…ªá†«á„…á…­/6.á„Œá…¥á†«á„á…¦á„ƒá…¦á„‹á…µá„á…¥á„’á…¡á†¸á„á…µá„€á…µ/1.Combined.xlsx")
# names(test)
# path_test = "/Users/Ido/Documents/GitHub/KFS_Timeseries_Data/4.Exported Data_by ID/@_á„Œá…©á„…á…µá†·/(@á„‹á…ªá†«á„…á…­)á„‰á…®á„Œá…©á†¼á„‡á…§á†¯ á„Œá…©á„…á…µá†·á„‰á…µá†¯á„Œá…¥á†¨Plantation forest by tree species/@á„‹á…ªá†«á„…á…­/(@á„‹á…ªá†«á„…á…­)4.2004~2022 á„á…µá†·á„‹á…§á†¸á„‰á…®, á„’á…ªá†¯á„‹á…§á†¸á„‰á…® á„ƒá…¦á„‹á…µá„á…¥á„’á…¡á†¸á„á…µá„€á…µ.xlsx"
# test = read.xlsx(path_test)
# names(test)


## ğŸŸ© ì—´ ì´ë¦„ í™•ì¸ ===========================================================================================
data_1999_sub %>% names
data_combined_sub %>% names



## ğŸŸ© ì—´ ì´ë¦„ ë³€ê²½ ===========================================================================================
library(dplyr)
library(stringr)

# ì—´ ì´ë¦„ ë³€ê²½
data_1999_sub <- data_1999_sub %>%
  rename_with(~ str_replace(., "_ê³„", "_ë©´ì "))

# ë³€ê²½ëœ ì—´ ì´ë¦„ í™•ì¸
print(names(data_1999_sub))
data_1999_sub_2 = data_1999_sub %>% rename("êµ¬ë¶„" := "êµ¬ë¶„_1", "í•©ê³„_ë©´ì " := "ê³„_ë©´ì ")
names(data_1999_sub_2)

# grep("ì˜¤ë™", names(data_combined_sub), value=T)
# "ì£ë‚˜ë¬´_ë©´ì "      
# "ë‚™ì—½ì†¡_ë©´ì "       "ì‚¼ë‚˜ë¬´_ë©´ì "       "í¸ë°±_ë©´ì "         "ë¦¬ê¸°ë‹¤_ë©´ì "      
# "í…Œë‹¤_ë©´ì "         "ë¦¬ê¸°í…Œë‹¤_ë©´ì "     "ê°•ì†¡_ë©´ì "         "í•´ì†¡_ë©´ì "        
# 
# 
# "ë°¤ë‚˜ë¬´_ë©´ì "       "ì´íƒœë¦¬í¬í”ŒëŸ¬_ë©´ì " "í˜„ì‚¬ì‹œ_ë©´ì "       "ì˜¤ë™_ë©´ì "

# ì—´ ì´ë¦„ ë³€ê²½
data_1999_sub_3 <- data_1999_sub_2 %>%
  rename_with(~ if_else(str_detect(., "ì£ë‚˜ë¬´_ë©´ì |ë‚™ì—½ì†¡_ë©´ì |ì‚¼ë‚˜ë¬´_ë©´ì |í¸ë°±_ë©´ì |ë¦¬ê¸°ë‹¤_ë©´ì |í…Œë‹¤_ë©´ì |ë¦¬ê¸°í…Œë‹¤_ë©´ì |ê°•ì†¡_ë©´ì |í•´ì†¡_ë©´ì "),
                        str_c("ì¹¨ì—½ìˆ˜_", .), .),
              .cols = c("ì£ë‚˜ë¬´_ë©´ì ", "ë‚™ì—½ì†¡_ë©´ì ", "ì‚¼ë‚˜ë¬´_ë©´ì ", "í¸ë°±_ë©´ì ", "ë¦¬ê¸°ë‹¤_ë©´ì ", "í…Œë‹¤_ë©´ì ", "ë¦¬ê¸°í…Œë‹¤_ë©´ì ", "ê°•ì†¡_ë©´ì ", "í•´ì†¡_ë©´ì ")) %>%
  rename_with(~ if_else(str_detect(., "ë°¤ë‚˜ë¬´_ë©´ì |ì´íƒœë¦¬í¬í”ŒëŸ¬_ë©´ì |í˜„ì‚¬ì‹œ_ë©´ì |ì˜¤ë™_ë©´ì "),
                        str_c("í™œì—½ìˆ˜_", .), .),
              .cols = c("ë°¤ë‚˜ë¬´_ë©´ì ", "ì´íƒœë¦¬í¬í”ŒëŸ¬_ë©´ì ", "í˜„ì‚¬ì‹œ_ë©´ì ", "ì˜¤ë™_ë©´ì "))

# ë³€ê²½ëœ ì—´ ì´ë¦„ í™•ì¸
print(names(data_1999_sub_3))




## ğŸŸ© ì—´ ì´ë¦„ í™•ì¸ ===========================================================================================
names(data_1999_sub_3)[!names(data_1999_sub_3) %in% names(data_combined_sub)]


data_combined_sub %>% names



## ğŸŸ¨ ê¸°íƒ€ì—ì„œì˜ í™œì—½ìˆ˜ ì¹¨ì—½ìˆ˜ ë¹„ìœ¨ ì¶”ì • ===========================================================================================
View(data_combined_sub)
# 'êµ¬ë¶„' ì—´ì˜ uniqueí•œ í–‰ë“¤ì„ êµ¬í•˜ë˜, 'year' ì—´ì„ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ í° ê°’ì˜ í–‰ì„ ì„ íƒ
unique_rows <- data_combined_sub %>%
  mutate(year = as.numeric(year)) %>%  # 'year' ì—´ì„ ìˆ˜ì¹˜í˜•ìœ¼ë¡œ ë³€í™˜
  group_by(êµ¬ë¶„) %>%  # 'êµ¬ë¶„' ì—´ë¡œ ê·¸ë£¹í™”
  filter(year == max(year)) %>%  # ê° ê·¸ë£¹ ë‚´ì—ì„œ 'year' ê°’ì´ ìµœëŒ€ì¸ í–‰ë§Œ í•„í„°ë§
  ungroup()  # ê·¸ë£¹í™” í•´ì œ

# ë¹„ìœ¨ ì¶”ì •
conifer_sum = sum(unique_rows$ì¹¨ì—½ìˆ˜_ê¸°íƒ€_ë©´ì )
broadleaf_sum = sum(unique_rows$í™œì—½ìˆ˜_ê¸°íƒ€_ë©´ì )

prop_conifer = conifer_sum/(broadleaf_sum + conifer_sum)


# ì¶”ì •ëœ ë¹„ìœ¨ë¡œ ê¸°íƒ€ ë©´ì  ë‚˜ëˆ„ê¸°
data_1999_sub_3$ì¹¨ì—½ìˆ˜_ê¸°íƒ€_ë©´ì _ì¶”ì • = data_1999_sub_3$ê¸°íƒ€_ë©´ì  * prop_conifer
data_1999_sub_3$í™œì—½ìˆ˜_ê¸°íƒ€_ë©´ì _ì¶”ì • = data_1999_sub_3$ê¸°íƒ€_ë©´ì  * (1-prop_conifer)
# data_1999_sub_3$ì¹¨ì—½ìˆ˜_ê¸°íƒ€_ë©´ì _ì¶”ì • + data_1999_sub_3$í™œì—½ìˆ˜_ê¸°íƒ€_ë©´ì _ì¶”ì • == data_1999_sub_3$ê¸°íƒ€_ë©´ì 




## ğŸŸ¨ í™œì—½ìˆ˜ ì¹¨ì—½ìˆ˜ í•©ê³„ ë©´ì  ì¶”ì • ===========================================================================================
# ì¹¨ì—½ìˆ˜ ì—´ë“¤ì˜ í•©ê³„ ê³„ì‚°
data_1999_sub_4 <- data_1999_sub_3 %>%
  mutate(ì¹¨ì—½ìˆ˜_í•©ê³„_ë©´ì  = rowSums(select(., starts_with("ì¹¨ì—½ìˆ˜_")), na.rm = TRUE))
data_1999_sub_3 %>% select(starts_with("ì¹¨ì—½ìˆ˜_")) %>% names
data_1999_sub_3 %>% select(starts_with("ì¹¨ì—½ìˆ˜_")) %>% slice(1)
test = c(16746, 32622, 4088, 7517, 459, 1573, 156, 348.6174)
sum(test)

# data_1999_sub_4$ì¹¨ì—½ìˆ˜_í•©ê³„_ë©´ì [1]


data_1999_sub_4 <- data_1999_sub_3 %>%
  mutate(ì¹¨ì—½ìˆ˜_í•©ê³„_ë©´ì  = rowSums(select(., starts_with("ì¹¨ì—½ìˆ˜_")), na.rm = TRUE))
# data_1999_sub_3 %>% names

# í™œì—½ìˆ˜ ì—´ë“¤ì˜ í•©ê³„ ê³„ì‚°
data_1999_sub_5 <- data_1999_sub_4 %>%
  mutate(í™œì—½ìˆ˜_í•©ê³„_ë©´ì  = rowSums(select(., starts_with("í™œì—½ìˆ˜_")), na.rm = TRUE))

# ê²°ê³¼ ì¶œë ¥ì„ ìœ„í•´ ì¼ë¶€ ì—´ë§Œ ë³´ê¸°
View(data_1999_sub_5 %>% select(ID, ì¹¨ì—½ìˆ˜_í•©ê³„_ë©´ì , í™œì—½ìˆ˜_í•©ê³„_ë©´ì ))
data_1999_sub_3[5,] %>% View


names(data_1999_sub_5)
data_1999_sub_5$ë¹„ê³  = "ì¹¨ì—½, í™œì—½ ê° í•©ê³„ëŠ” ì¶”ì •ì¹˜"
data_1999_sub_5 = data_1999_sub_5 %>% relocate("ë¹„ê³ ")
# data_1999_sub_3 = data_1999_sub_3 %>% rename()
names(data_1999_sub_5)




## ğŸŸ§ í•©ì¹˜ê¸° =====================================================================================
data_1999_new = cbind(data_1999_sub_5, data_1999[18:ncol(data_1999)])
names(data_1999_new)
names(data_combined)

combined = bind_rows(list(data_1999_new, data_combined)) %>% 
  relocate("í™œì—½ìˆ˜_í•©ê³„_ë©´ì ", "ì¹¨ì—½ìˆ˜_í•©ê³„_ë©´ì ")

names(combined)
View(combined)


## ğŸŸ§ êµ¬ë¶„ì—ì„œ "ë©´ì "ì œê±°  ====================================================================================
combined$year
combined$êµ¬ë¶„
# combined ë°ì´í„°í”„ë ˆì„ì˜ 'êµ¬ë¶„' ì—´ì—ì„œ ì—°ë„ë§Œ ì¶”ì¶œ
combined$êµ¬ë¶„ <- gsub("[^0-9]", "", combined$êµ¬ë¶„)

# ê²°ê³¼ í™•ì¸
print(combined$êµ¬ë¶„)



## ğŸŸ§ ë‚´ë³´ë‚´ê¸° ====================================================================================
path_save = "/Users/Ido/Documents/GitHub/KFS_Timeseries_Data/4.Exported Data_by ID/@_á„Œá…©á„…á…µá†·/(@á„‹á…ªá†«á„…á…­)á„‰á…®á„Œá…©á†¼á„‡á…§á†¯ á„Œá…©á„…á…µá†·á„‰á…µá†¯á„Œá…¥á†¨Plantation forest by tree species/@á„‹á…ªá†«á„…á…­/6.á„Œá…¥á†«á„á…¦á„ƒá…¦á„‹á…µá„á…¥á„’á…¡á†¸á„á…µá„€á…µ"
file_name = "3.Combined.xlsx"
# combined = read.xlsx(file.path(path_save, file_name))
write.xlsx(combined, file.path(path_save, file_name))





