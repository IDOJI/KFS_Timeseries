}
return(results)
}
## ğŸŸ§ ì—°ë„ í•©ê³„ íŒŒì¼ì´ ì•„ë‹Œ íŒŒì¼ë“¤ ì‚­ì œ ====================================================================================================
delete_non_year_files <- function(directory) {
# ëª¨ë“  csv íŒŒì¼ì„ ì¬ê·€ì ìœ¼ë¡œ ì°¾ê¸°
files <- list.files(directory, pattern = "\\.csv$", recursive = TRUE, full.names = TRUE)
# ì—°ë„ ë˜ëŠ” ì—°ë„ë¥¼ í¬í•¨í•œ ë¬¸ìì—´ì„ íŒë‹¨í•˜ê¸° ìœ„í•œ ì •ê·œ í‘œí˜„ì‹
year_regex <- "^[0-9]{4}.*$"
# íŒŒì¼ ì‚­ì œ ì¹´ìš´í„°
deleted_files <- 0
for (file in files) {
# íŒŒì¼ ì´ë¦„ì—ì„œ í™•ì¥ì ì œê±°
file_name <- basename(file)
file_name <- sub("\\.csv$", "", file_name)
# íŒŒì¼ ì´ë¦„ì„ "___"ë¡œ ë¶„í• 
parts <- unlist(strsplit(file_name, "___"))
# ë‘ ë²ˆì§¸ ë¶€ë¶„ì´ ì—°ë„ ë˜ëŠ” ì—°ë„ë¥¼ í¬í•¨í•œ ë¬¸ìì—´ì¸ì§€ í™•ì¸
if (length(parts) >= 2) {
second_part <- parts[2]
if (!grepl(year_regex, second_part)) {
# ì—°ë„ ë˜ëŠ” ì—°ë„ë¥¼ í¬í•¨í•œ ë¬¸ìì—´ì´ ì•„ë‹ˆë©´ íŒŒì¼ ì‚­ì œ
file.remove(file)
deleted_files <- deleted_files + 1
cat("Deleted:", file, "\n")
}
}
}
cat("Total files deleted:", deleted_files, "\n")
}
## ğŸŸ§ ì—°ë„ë³„ ë‚´ë³´ë‚´ê³  ìµœë¹ˆê°’ìœ¼ë¡œ í•©ì¹˜ê¸° ====================================================================================================
each_year_total_copy_data_by_year_by_max_value_rows = function(yb,
path_from,
path_to,
L3,
item,
years_regions = c(),
total_include.list,
total_exclude.list,
message = T,
remove.files = F){
# path_to = path_to_upper
if(length(years_regions) > 0){
for(k in seq_along(total_include.list)){
# k=1
# k=i=1
# i=26
tryCatch({
cat(crayon::blue("\nStarting outer loop with k = "), k, "\n")
for(i in seq_along(years_regions)){
cat(crayon::blue(k, i, "\n"))
tryCatch({
cat(crayon::blue("  Starting inner loop with k = "), k, " and i = ", i, "\n")
ith_year = years_regions[i]
# change
kth_include.list = lapply(total_include.list[[k]], function(x){ c(x, ith_year) })
kth_exclude.list = total_exclude.list[[k]]
kth_sub_category = names(total_include.list)[k]
kth_path_to = file.path(path_to, kth_sub_category) # path ì„¤ì •
# function
ith_results = copy_data_by_year(yb,
path_from,
path_to = kth_path_to,
save_file_name = paste0(L3, "___", kth_sub_category, "___", ith_year),
include.list = kth_include.list,
exclude.list = kth_exclude.list,
message,
remove.files)
cat(crayon::blue("  Finished inner loop with k = "), k, " and i = ", i, "\n")
}, error = function(e) {
cat(crayon::red("Error in inner loop with k = "), k, " and i = ", i, ": ", e$message, "\n")
stop(e)
})
}
# remove.files=F
tryCatch({
# ê° ì¶”ì¶œëœ ì—°ë„ë³„ ë°ì´í„° í•©ì¹˜ê¸° (ìµœë¹ˆê°’ ê¸°ì¤€)
process_and_export_most_frequent_value_rows(path_to = kth_path_to, output_file = paste0(L3, "___", kth_sub_category, "___Total"))
cat(crayon::green("Exporting is done: "), crayon::bgMagenta(paste0(L3, "_", kth_sub_category)), "\n")
}, error = function(e) {
cat(crayon::red("Error in process_and_export_most_frequent_value_rows with k = "), k, ": ", e$message, "\n")
stop(e)
})
cat(crayon::blue("Finished outer loop with k = "), k, "\n")
}, error = function(e) {
cat(crayon::red("Error in outer loop with k = "), k, " and last i = ", if (exists("i")) i else "not started", ": ", e$message, "\n")
stop(e)
})
}
}else{
for(k in seq_along(total_include.list)){
# k=1
# k=i=1
# i=26
tryCatch({
cat(crayon::blue("\nStarting outer loop with k = "), k, "\n")
tryCatch({
# change
kth_include.list = total_include.list[[k]]
kth_exclude.list = total_exclude.list[[k]]
kth_sub_category = names(total_include.list)[k]
# kth_path_to = file.path(path_to, kth_sub_category) # path ì„¤ì •
# function
kth_results = copy_data_by_year(yb,
path_from,
path_to = path_to,
save_file_name = paste0(kth_sub_category),
include.list = kth_include.list,
exclude.list = kth_exclude.list,
message,
remove.files)
}, error = function(e) {
cat(crayon::red("Error in inner loop with k = "), k, " and i = ", i, ": ", e$message, "\n")
stop(e)
})
# remove.files=F
# tryCatch({
#   # ê° ì¶”ì¶œëœ ì—°ë„ë³„ ë°ì´í„° í•©ì¹˜ê¸° (ìµœë¹ˆê°’ ê¸°ì¤€)
#   process_and_export_most_frequent_value_rows(path_to = kth_path_to, output_file = paste0(L3, "___", kth_sub_category, "___Total"))
#
#   cat(crayon::green("Exporting is done: "), crayon::bgMagenta(paste0(L3, "_", kth_sub_category)), "\n")
# }, error = function(e) {
#   cat(crayon::red("Error in process_and_export_most_frequent_value_rows with k = "), k, ": ", e$message, "\n")
#   stop(e)
# })
cat(crayon::blue("Finished outer loop with k = "), k, "\n")
}, error = function(e) {
cat(crayon::red("Error in outer loop with k = "), k, " and last i = ", if (exists("i")) i else "not started", ": ", e$message, "\n")
stop(e)
})
}
}
}
# message=F
## ğŸŸ§ ë¦¬ìŠ¤íŠ¸ 2ê°œ ë¹„êµ =============================================================
# ë‘ ê°œì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„êµí•˜ì—¬ ê¸¸ì´ì™€ ì›ì†Œ ì´ë¦„ì´ ë™ì¼í•œì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
# ë‘ ê°œì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„êµí•˜ì—¬ ê¸¸ì´ì™€ ì›ì†Œ ì´ë¦„ì´ ë™ì¼í•œì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
library(crayon)
# ë‘ ê°œì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„êµí•˜ì—¬ ê¸¸ì´ì™€ ì›ì†Œ ì´ë¦„ì´ ë™ì¼í•œì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
compare_lists <- function(list1, list2) {
# ë‘ ë¦¬ìŠ¤íŠ¸ì˜ ê¸¸ì´ ë¹„êµ
if (length(list1) != length(list2)) {
cat(red("The lists have different lengths.\n"))
return(FALSE)
}
# ë‘ ë¦¬ìŠ¤íŠ¸ì˜ ì›ì†Œ ì´ë¦„ ë¹„êµ
names1 <- names(list1)
names2 <- names(list2)
if (is.null(names1) || is.null(names2)) {
cat(red("One or both of the lists do not have names.\n"))
return(FALSE)
}
if (!all(names1 == names2)) {
cat(red("The lists have different names.\n"))
return(FALSE)
}
cat(green("The lists have the same length and names.\n"))
return(TRUE)
}
## ğŸŸ§ csv íŒŒì¼ í•„ ========================================================================
get_filtered_csv_files <- function(path, include = NULL, exclude = NULL) {
# Load necessary library
library(stringr)
# List all CSV files recursively
all_files <- list.files(path, pattern = "\\.csv$", recursive = TRUE, full.names = FALSE)
# Extract the specific part of the file name
extract_name_part <- function(filename) {
parts <- str_split(filename, "___")[[1]]
if (length(parts) >= 2) {
return(paste(parts[1], parts[2], sep = "___"))
} else {
return(NA)
}
}
extracted_names <- sapply(all_files, extract_name_part)
valid_files <- !is.na(extracted_names)
extracted_names <- extracted_names[valid_files]
all_files <- all_files[valid_files]
# Filter based on include criteria (all strings in include must be present)
if (!is.null(include)) {
include_indices <- sapply(include, function(inc) grepl(inc, extracted_names))
include_indices <- apply(include_indices, 1, all)
} else {
include_indices <- rep(TRUE, length(extracted_names))
}
# Filter based on exclude criteria (any string in exclude must not be present)
if (!is.null(exclude)) {
exclude_indices <- sapply(exclude, function(exc) grepl(exc, extracted_names))
exclude_indices <- apply(exclude_indices, 1, any)
} else {
exclude_indices <- rep(FALSE, length(extracted_names))
}
final_indices <- include_indices & !exclude_indices
filtered_files <- all_files[final_indices]
# Return only the names of the filtered files
return(basename(filtered_files))
}
# ğŸŸ¥ ë°ì´í„° ë¡œë“œ ==================================================================================
path_2020 = "/Users/Ido/Documents/GitHub/KFS_Timeseries_Data/5.á„ƒá…µá„Œá…µá„á…¥á†¯á„‰á…®á‡á„€á…¡á„á…®á„€á…µ/Exported_2/comparison 2020.csv"
path_2021 = "/Users/Ido/Documents/GitHub/KFS_Timeseries_Data/5.á„ƒá…µá„Œá…µá„á…¥á†¯á„‰á…®á‡á„€á…¡á„á…®á„€á…µ/Exported_2/comparison 2021.csv"
data_2020 = read.csv(path_2020)
data_2021 = read.csv(path_2021)
# ğŸŸ¨ ë°ì´í„° í•©ì¹˜ê¸° ==================================================================================
names(data_2020)
names(data_2021)
data_2020$year
data_combined = rbind(data_2020, data_2021)
View(data_combined)
# ğŸŸ¨ ì–´ë¦°ë‚˜ë¬´ ê°€ê¾¸ê¸°, í°ë‚˜ë¬´ ê°€ê¾¸ê¸°ë§Œ ë‚¨ê¸°ê¸°==================================================================================
data_combined_2 = data_combined %>% filter(forest_tending %in% c("ì–´ë¦°ë‚˜ë¬´ê°€ê¾¸ê¸°", "í°ë‚˜ë¬´ê°€ê¾¸ê¸°"))
data_combined_2
# ğŸŸ© Bland-Altman test ==================================================================================
install.packages("devtools")
devtools::install_github("deepankardatta/blandr")
install.packages("devtools")
require(blandr)
# Perform Bland-Altman analysis and display the statistics
blandr.statistics(measurement1, measurement2)
devtools::install_github("deepankardatta/blandr")
# ğŸŸ© Bland-Altman test ==================================================================================
# install.packages("devtools")
# devtools::install_github("deepankardatta/blandr")
requore(blandr)
# ğŸŸ© Bland-Altman test ==================================================================================
# install.packages("devtools")
# devtools::install_github("deepankardatta/blandr")
require(blandr)
# Perform Bland-Altman analysis and display the statistics
blandr.statistics(measurement1, measurement2)
# Perform Bland-Altman analysis and display the statistics
blandr.statistics(data_combined_2$total_work_area_yb, data_combined_2$total_work_area_digital_ha)
# data
dig = data_combined_2$total_work_area_digital_ha
yb = data_combined_2$total_work_area_yb
# Perform Bland-Altman analysis and display the statistics
blandr.statistics(dig, yb)
# Display a Bland-Altman plot
blandr.display(dig, yb, sig.level = 0.95)
# Perform Bland-Altman analysis
stats <- blandr.statistics(measurement1, measurement2)
# Plot using ggplot2
blandr.plot.ggplot(stats)
# Perform Bland-Altman analysis and display the statistics
stats <- blandr.statistics(dig, yb)
blandr.plot.ggplot(stats)
blandr::blandr.display.and.draw(method1 = dig,
method2 = yb,
method1name = "Digital",
method2name = "YearBook",
sig.level = 0.95,
annotate = T,
ciDisplay = T)
# Plot using ggplot2
blandr.plot.ggplot(stats)
# Bland-Altman ë¶„ì„ ë° outlier ë ˆì´ë¸” í‘œì‹œ í•¨ìˆ˜ (ë²¡í„° ì…ë ¥ìš©)
bland_altman_with_labels <- function(method1, method2, labels, threshold_factor = 2) {
# Bland-Altman í†µê³„ ê³„ì‚°
stats <- blandr.statistics(method1, method2)
# í†µê³„ ë°ì´í„°í”„ë ˆì„ ìƒì„±
data <- data.frame(
means = stats$means,
differences = stats$differences,
labels = labels
)
# ì°¨ì´ì˜ í‘œì¤€í¸ì°¨ ê³„ì‚°
threshold <- threshold_factor * sd(data$differences)
# outliersì— í•´ë‹¹í•˜ëŠ” ì ì—ë§Œ ë ˆì´ë¸”ì„ í‘œì‹œ
data$labels_to_plot <- ifelse(abs(data$differences) > threshold, data$labels, "")
# Bland-Altman plot ìƒì„± ë° outliersì— ë ˆì´ë¸” í‘œì‹œ
p <- ggplot(data, aes(x = means, y = differences)) +
geom_point(size = 2) +
geom_hline(yintercept = stats$bias, linetype = "solid", color = "red") +
geom_hline(yintercept = stats$upperLOA, linetype = "dashed", color = "blue") +
geom_hline(yintercept = stats$lowerLOA, linetype = "dashed", color = "blue") +
geom_text(aes(label = labels_to_plot), vjust = -1, size = 3) +  # ìœ ì˜í•œ ì°¨ì´ê°€ ë‚˜ëŠ” ì ì—ë§Œ ë ˆì´ë¸” ì¶”ê°€
ggtitle("Bland-Altman Plot with Outlier Labels") +
xlab("Mean of Two Methods") +
ylab("Difference Between Two Methods") +
theme_minimal()
# Plot ì¶œë ¥
print(p)
}
data_combined_2$year
labels = paste(data_combined_2$regions,
data_combined_2$forest_tending,
data_combined_2$year,
sep = "_")
labels
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
require(ggplot2)
# Bland-Altman ë¶„ì„ ë° outlier ë ˆì´ë¸” í‘œì‹œ í•¨ìˆ˜ (ë²¡í„° ì…ë ¥ìš©)
bland_altman_with_labels <- function(method1, method2, labels, threshold_factor = 2) {
require(ggplot2)
# Bland-Altman í†µê³„ ê³„ì‚°
stats <- blandr.statistics(method1, method2)
# í†µê³„ ë°ì´í„°í”„ë ˆì„ ìƒì„±
data <- data.frame(
means = stats$means,
differences = stats$differences,
labels = labels
)
# ì°¨ì´ì˜ í‘œì¤€í¸ì°¨ ê³„ì‚°
threshold <- threshold_factor * sd(data$differences)
# outliersì— í•´ë‹¹í•˜ëŠ” ì ì—ë§Œ ë ˆì´ë¸”ì„ í‘œì‹œ
data$labels_to_plot <- ifelse(abs(data$differences) > threshold, data$labels, "")
# Bland-Altman plot ìƒì„± ë° outliersì— ë ˆì´ë¸” í‘œì‹œ
p <- ggplot(data, aes(x = means, y = differences)) +
geom_point(size = 2) +
geom_hline(yintercept = stats$bias, linetype = "solid", color = "red") +
geom_hline(yintercept = stats$upperLOA, linetype = "dashed", color = "blue") +
geom_hline(yintercept = stats$lowerLOA, linetype = "dashed", color = "blue") +
geom_text(aes(label = labels_to_plot), vjust = -1, size = 3) +  # ìœ ì˜í•œ ì°¨ì´ê°€ ë‚˜ëŠ” ì ì—ë§Œ ë ˆì´ë¸” ì¶”ê°€
ggtitle("Bland-Altman Plot with Outlier Labels") +
xlab("Mean of Two Methods") +
ylab("Difference Between Two Methods") +
theme_minimal()
# Plot ì¶œë ¥
print(p)
}
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
# Plot using ggplot2
blandr.plot.ggplot(stats)
# my function
labels = paste(data_combined_2$regions,
data_combined_2$forest_tending,
data_combined_2$year,
sep = "_")
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
# Plot using ggplot2
blandr.plot.ggplot(stats)
# í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ë¡œë“œ
install.packages("showtext")
library(showtext)
library(ggplot2)
# í•œê¸€ í°íŠ¸ ì‚¬ìš© ì„¤ì • (ì˜ˆ: ë‚˜ëˆ”ê³ ë”•)
font_add_google("Nanum Gothic", "nanumgothic")
showtext_auto()
# Bland-Altman ë¶„ì„ ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜ í¬í•¨í•œ ë ˆì´ë¸” í‘œì‹œ í•¨ìˆ˜ (í•œê¸€ í°íŠ¸ ì§€ì›)
bland_altman_with_ci_and_labels <- function(method1, method2, labels, threshold_factor = 2) {
# Bland-Altman í†µê³„ ê³„ì‚°
stats <- blandr.statistics(method1, method2)
# í†µê³„ ë°ì´í„°í”„ë ˆì„ ìƒì„±
data <- data.frame(
means = stats$means,
differences = stats$differences,
labels = labels
)
# ì°¨ì´ì˜ í‘œì¤€í¸ì°¨ ê³„ì‚°
threshold <- threshold_factor * sd(data$differences)
# outliersì— í•´ë‹¹í•˜ëŠ” ì ì—ë§Œ ë ˆì´ë¸”ì„ í‘œì‹œ
data$labels_to_plot <- ifelse(abs(data$differences) > threshold, data$labels, "")
# Bland-Altman plot ìƒì„±
p <- ggplot(data, aes(x = means, y = differences)) +
geom_point(size = 2) +
# Bias Line ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = stats$bias, linetype = "solid", color = "red") +
geom_ribbon(aes(ymin = stats$biasLowerCI, ymax = stats$biasUpperCI), alpha = 0.2, fill = "red") +
# Upper Limit of Agreement (Upper LoA) ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = stats$upperLOA, linetype = "dashed", color = "blue") +
geom_ribbon(aes(ymin = stats$upperLOA_lowerCI, ymax = stats$upperLOA_upperCI), alpha = 0.2, fill = "blue") +
# Lower Limit of Agreement (Lower LoA) ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = stats$lowerLOA, linetype = "dashed", color = "blue") +
geom_ribbon(aes(ymin = stats$lowerLOA_lowerCI, ymax = stats$lowerLOA_upperCI), alpha = 0.2, fill = "blue") +
# Outlier ë ˆì´ë¸” ì¶”ê°€
geom_text(aes(label = labels_to_plot), vjust = -1, size = 3, family = "nanumgothic") +  # í•œê¸€ í°íŠ¸ ì ìš©
ggtitle("Bland-Altman Plot with Confidence Intervals and Outlier Labels", family = "nanumgothic") +
xlab("Mean of Two Methods") +
ylab("Difference Between Two Methods") +
theme_minimal()
# Plot ì¶œë ¥
print(p)
}
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
# í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ë¡œë“œ
install.packages("blandr")
install.packages("ggplot2")
install.packages("showtext")
library(blandr)
library(ggplot2)
library(showtext)
# í•œê¸€ í°íŠ¸ ì„¤ì •
font_add_google("Nanum Gothic", "nanumgothic")
showtext_auto()
# Bland-Altman ë¶„ì„ ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜ í¬í•¨í•œ ë ˆì´ë¸” í‘œì‹œ í•¨ìˆ˜
bland_altman_with_ci_and_labels <- function(method1, method2, labels, threshold_factor = 2, sig.level = 0.95) {
# Bland-Altman í†µê³„ ê³„ì‚°
stats <- blandr.statistics(method1, method2, sig.level = sig.level)
# í†µê³„ ë°ì´í„°í”„ë ˆì„ ìƒì„±
data <- data.frame(
means = stats$means,
differences = stats$differences,
labels = labels
)
# ì°¨ì´ì˜ í‘œì¤€í¸ì°¨ ê³„ì‚°
threshold <- threshold_factor * sd(data$differences)
# outliersì— í•´ë‹¹í•˜ëŠ” ì ì—ë§Œ ë ˆì´ë¸”ì„ í‘œì‹œ
data$labels_to_plot <- ifelse(abs(data$differences) > threshold, data$labels, "")
# ì‹ ë¢°êµ¬ê°„ ìˆ˜ë™ ê³„ì‚°
bias <- stats$bias
bias_se <- stats$biasSEM  # Biasì˜ í‘œì¤€ì˜¤ì°¨
z_value <- qnorm(1 - (1 - sig.level) / 2)  # Zê°’ ê³„ì‚° (ì˜ˆ: 95% ì‹ ë¢°êµ¬ê°„ì— í•´ë‹¹í•˜ëŠ” zê°’)
# Bias ì‹ ë¢°êµ¬ê°„
bias_upper_ci <- bias + z_value * bias_se
bias_lower_ci <- bias - z_value * bias_se
# Limits of Agreement ì‹ ë¢°êµ¬ê°„ ê³„ì‚°
loa_se <- stats$LOA_SEM  # Limits of Agreementì˜ í‘œì¤€ì˜¤ì°¨
upper_loa_upper_ci <- stats$upperLOA + z_value * loa_se
upper_loa_lower_ci <- stats$upperLOA - z_value * loa_se
lower_loa_upper_ci <- stats$lowerLOA + z_value * loa_se
lower_loa_lower_ci <- stats$lowerLOA - z_value * loa_se
# Bland-Altman plot ìƒì„±
p <- ggplot(data, aes(x = means, y = differences)) +
geom_point(size = 2) +
# Bias Line ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = bias, linetype = "solid", color = "red") +
geom_ribbon(aes(ymin = bias_lower_ci, ymax = bias_upper_ci), alpha = 0.2, fill = "red") +
# Upper Limit of Agreement (Upper LoA) ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = stats$upperLOA, linetype = "dashed", color = "blue") +
geom_ribbon(aes(ymin = upper_loa_lower_ci, ymax = upper_loa_upper_ci), alpha = 0.2, fill = "blue") +
# Lower Limit of Agreement (Lower LoA) ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = stats$lowerLOA, linetype = "dashed", color = "blue") +
geom_ribbon(aes(ymin = lower_loa_lower_ci, ymax = lower_loa_upper_ci), alpha = 0.2, fill = "blue") +
# Outlier ë ˆì´ë¸” ì¶”ê°€
geom_text(aes(label = labels_to_plot), vjust = -1, size = 3, family = "nanumgothic") +  # í•œê¸€ í°íŠ¸ ì ìš©
ggtitle("Bland-Altman Plot with Confidence Intervals and Outlier Labels", family = "nanumgothic") +
xlab("Mean of Two Methods") +
ylab("Difference Between Two Methods") +
theme_minimal()
# Plot ì¶œë ¥
print(p)
}
install.packages("ggplot2")
install.packages("showtext")
install.packages("blandr")
install.packages("blandr")
library(blandr)
library(ggplot2)
library(showtext)
# í•œê¸€ í°íŠ¸ ì„¤ì •
font_add_google("Nanum Gothic", "nanumgothic")
showtext_auto()
# Bland-Altman ë¶„ì„ ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜ í¬í•¨í•œ ë ˆì´ë¸” í‘œì‹œ í•¨ìˆ˜
bland_altman_with_ci_and_labels <- function(method1, method2, labels, threshold_factor = 2, sig.level = 0.95) {
# Bland-Altman í†µê³„ ê³„ì‚°
stats <- blandr.statistics(method1, method2, sig.level = sig.level)
# í†µê³„ ë°ì´í„°í”„ë ˆì„ ìƒì„±
data <- data.frame(
means = stats$means,
differences = stats$differences,
labels = labels
)
# ì°¨ì´ì˜ í‘œì¤€í¸ì°¨ ê³„ì‚°
threshold <- threshold_factor * sd(data$differences)
# outliersì— í•´ë‹¹í•˜ëŠ” ì ì—ë§Œ ë ˆì´ë¸”ì„ í‘œì‹œ
data$labels_to_plot <- ifelse(abs(data$differences) > threshold, data$labels, "")
# ì‹ ë¢°êµ¬ê°„ ìˆ˜ë™ ê³„ì‚°
bias <- stats$bias
bias_se <- stats$biasSEM  # Biasì˜ í‘œì¤€ì˜¤ì°¨
z_value <- qnorm(1 - (1 - sig.level) / 2)  # Zê°’ ê³„ì‚° (ì˜ˆ: 95% ì‹ ë¢°êµ¬ê°„ì— í•´ë‹¹í•˜ëŠ” zê°’)
# Bias ì‹ ë¢°êµ¬ê°„
bias_upper_ci <- bias + z_value * bias_se
bias_lower_ci <- bias - z_value * bias_se
# Limits of Agreement ì‹ ë¢°êµ¬ê°„ ê³„ì‚°
loa_se <- stats$LOA_SEM  # Limits of Agreementì˜ í‘œì¤€ì˜¤ì°¨
upper_loa_upper_ci <- stats$upperLOA + z_value * loa_se
upper_loa_lower_ci <- stats$upperLOA - z_value * loa_se
lower_loa_upper_ci <- stats$lowerLOA + z_value * loa_se
lower_loa_lower_ci <- stats$lowerLOA - z_value * loa_se
# Bland-Altman plot ìƒì„±
p <- ggplot(data, aes(x = means, y = differences)) +
geom_point(size = 2) +
# Bias Line ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = bias, linetype = "solid", color = "red") +
geom_ribbon(aes(ymin = bias_lower_ci, ymax = bias_upper_ci), alpha = 0.2, fill = "red") +
# Upper Limit of Agreement (Upper LoA) ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = stats$upperLOA, linetype = "dashed", color = "blue") +
geom_ribbon(aes(ymin = upper_loa_lower_ci, ymax = upper_loa_upper_ci), alpha = 0.2, fill = "blue") +
# Lower Limit of Agreement (Lower LoA) ë° ì‹ ë¢°êµ¬ê°„ ìŒì˜
geom_hline(yintercept = stats$lowerLOA, linetype = "dashed", color = "blue") +
geom_ribbon(aes(ymin = lower_loa_lower_ci, ymax = lower_loa_upper_ci), alpha = 0.2, fill = "blue") +
# Outlier ë ˆì´ë¸” ì¶”ê°€
geom_text(aes(label = labels_to_plot), vjust = -1, size = 3, family = "nanumgothic") +  # í•œê¸€ í°íŠ¸ ì ìš©
ggtitle("Bland-Altman Plot with Confidence Intervals and Outlier Labels", family = "nanumgothic") +
xlab("Mean of Two Methods") +
ylab("Difference Between Two Methods") +
theme_minimal()
# Plot ì¶œë ¥
print(p)
}
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
bland_altman_with_labels(method1 = dig,
method2 = yb,
labels = labels)
